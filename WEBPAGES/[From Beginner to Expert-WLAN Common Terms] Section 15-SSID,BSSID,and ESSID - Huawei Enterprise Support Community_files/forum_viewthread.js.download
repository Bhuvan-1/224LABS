/*
 [Discuz!] (C)2001-2099 Comsenz Inc.
 This is NOT a freeware, use is subject to license terms

 $Id: forum_viewthread.js 33277 2013-05-14 06:00:11Z laoguozhang $
 */

var replyreload = '', attachimgST = new Array(), zoomgroup = new Array(), zoomgroupinit = new Array();

function attachimggroup(pid) {
	if(!zoomgroupinit[pid]) {
		for(i = 0;i < aimgcount[pid].length;i++) {
			zoomgroup['aimg_' + aimgcount[pid][i]] = pid;
		}
		zoomgroupinit[pid] = true;
	}
}

function attachimgshow(pid, onlyinpost) {
	onlyinpost = !onlyinpost ? false : onlyinpost;
	aimgs = aimgcount[pid];
	aimgcomplete = 0;
	loadingcount = 0;
	for(i = 0;i < aimgs.length;i++) {
		obj = $('aimg_' + aimgs[i]);
		if(!obj) {
			aimgcomplete++;
			continue;
		}
		if(onlyinpost && obj.getAttribute('inpost') || !onlyinpost) {
			if(!obj.status) {
				obj.status = 1;
				if(obj.getAttribute('file')) obj.src = obj.getAttribute('file');
				loadingcount++;
			} else if(obj.status == 1) {
				if(obj.complete) {
					obj.status = 2;
				} else {
					loadingcount++;
				}
			} else if(obj.status == 2) {
				aimgcomplete++;
				if(obj.getAttribute('thumbImg')) {
					thumbImg(obj);
				}
			}
			if(loadingcount >= 10) {
				break;
			}
		}
	}
	if(aimgcomplete < aimgs.length) {
		setTimeout(function () {
			attachimgshow(pid, onlyinpost);
		}, 100);
	}
}

function attachimglstshow(pid, islazy, fid, showexif) {
	var aimgs = aimgcount[pid];
	var s = '';
	if(fid) {
		s = ' onmouseover="showMenu({\'ctrlid\':this.id, \'pos\': \'12!\'});"';
	}
	if(typeof aimgcount == 'object' && $('imagelistthumb_' + pid)) {
		for(pid in aimgcount) {
			var imagelist = '';
			for(i = 0;i < aimgcount[pid].length;i++) {
				if(!$('aimg_' + aimgcount[pid][i]) || $('aimg_' + aimgcount[pid][i]).getAttribute('inpost') || parseInt(aimgcount[pid][i]) != aimgcount[pid][i]) {
					continue;
				}
				if(fid) {
					imagelist += '<div id="pattimg_' + aimgcount[pid][i] + '_menu" class="tip tip_4" style="display: none;"><div class="tip_horn"></div><div class="tip_c"><a href="forum.php?mod=ajax&action=setthreadcover&aid=' + aimgcount[pid][i] + '&fid=' + fid + '" class="xi2" onclick="showWindow(\'setcover' + aimgcount[pid][i] + '\', this.href)">'+jQuery.i18n.prop("forum_viewthread_249")+'</a></div></div>';
				}
				imagelist += '<div class="pattimg">' +
				'<a id="pattimg_' + aimgcount[pid][i] + '" class="pattimg_zoom" href="javascript:;"' + s + ' onclick="zoom($(\'aimg_' + aimgcount[pid][i] + '\'), attachimggetsrc(\'aimg_' + aimgcount[pid][i] + '\'), 0, 0, ' + (parseInt(showexif) ? 1 : 0) + ')" title="'+jQuery.i18n.prop("forum_viewthread_250")+'">'+jQuery.i18n.prop("forum_viewthread_250")+'</a>' +
				'<img ' + (islazy ? 'file' : 'src') + '="forum.php?mod=image&aid=' + aimgcount[pid][i] + '&size=100x100&key=' + imagelistkey + '&atid=' + tid + '" width="100" height="100" /></div>';
			}
			if($('imagelistthumb_' + pid)) {
				$('imagelistthumb_' + pid).innerHTML = imagelist;
			}
		}
	}
}

function attachimggetsrc(img) {
	return $(img).getAttribute('zoomfile') ? $(img).getAttribute('zoomfile') : $(img).getAttribute('file');
}

function attachimglst(pid, op, islazy) {
	if(!op) {
		$('imagelist_' + pid).style.display = 'none';
		$('imagelistthumb_' + pid).style.display = '';
	} else {
		$('imagelistthumb_' + pid).style.display = 'none';
		$('imagelist_' + pid).style.display = '';
		if(islazy) {
			o = new lazyload();
			o.showImage();
		} else {
			attachimgshow(pid);
		}
	}
	doane();
}

function attachimginfo(obj, infoobj, show, event) {
	objinfo = fetchOffset(obj);
	if(show) {
		$(infoobj).style.left = objinfo['left'] + 'px';
		$(infoobj).style.top = obj.offsetHeight < 40 ? (objinfo['top'] + obj.offsetHeight) + 'px' : objinfo['top'] + 'px';
		$(infoobj).style.display = '';
	} else {
		if(BROWSER.ie) {
			$(infoobj).style.display = 'none';
			return;
		} else {
			var mousex = document.body.scrollLeft + event.clientX;
			var mousey = document.documentElement.scrollTop + event.clientY;
			if(mousex < objinfo['left'] || mousex > objinfo['left'] + objinfo['width'] || mousey < objinfo['top'] || mousey > objinfo['top'] + objinfo['height']) {
				$(infoobj).style.display = 'none';
			}
		}
	}
}

function signature(obj) {
	if(obj.style.maxHeightIE != '') {
		var height = (obj.scrollHeight > parseInt(obj.style.maxHeightIE)) ? obj.style.maxHeightIE : obj.scrollHeight + 'px';
		if(obj.innerHTML.indexOf('<IMG ') == -1) {
			obj.style.maxHeightIE = '';
		}
		return height;
	}
}

function tagshow(event) {
	var obj = BROWSER.ie ? event.srcElement : event.target;
	ajaxmenu(obj, 0, 1, 2);
}

function parsetag(pid) {
	if(!$('postmessage_'+pid) || $('postmessage_'+pid).innerHTML.match(/<script[^\>]*?>/i)) {
		return;
	}
	var havetag = false;
	var tagfindarray = new Array();
	var str = $('postmessage_'+pid).innerHTML.replace(/(^|>)([^<]+)(?=<|$)/ig, function($1, $2, $3, $4) {
		for(i in tagarray) {
			if(tagarray[i] && $3.indexOf(tagarray[i]) != -1) {
				havetag = true;
				$3 = $3.replace(tagarray[i], '<h_ ' + i + '>');
				tmp = $3.replace(/&[a-z]*?<h_ \d+>[a-z]*?;/ig, '');
				if(tmp != $3) {
					$3 = tmp;
				} else {
					tagfindarray[i] = tagarray[i];
					tagarray[i] = '';
				}
			}
		}
		return $2 + $3;
	});
	if(havetag) {
		$('postmessage_'+pid).innerHTML = str.replace(/<h_ (\d+)>/ig, function($1, $2) {
			return '<span href=\"forum.php?mod=tag&name=' + tagencarray[$2] + '\" onclick=\"tagshow(event)\" class=\"t_tag\">' + tagfindarray[$2] + '</span>';
		});
	}
}

function setanswer(pid, from, type) {
	if (BROWSER.ie) {
		doane(event);
	}

	if ( ! type ) {
		var message = jQuery.i18n.prop("forum_viewthread_251");
		var url = 'forum.php?mod=misc&action=bestanswer&tid=' + tid + '&pid=' + pid + '&from=' + from + '&bestanswersubmit=yes';
	} else if ( 'recommend' == type ) {
		var message = jQuery.i18n.prop("recommend_answer_tip");
		var url = 'forum.php?mod=misc&action=recommend_answer&tid=' + tid + '&pid=' + pid + '&from=' + from + '&recommend_answer_submit=yes';
	} else if ( 'cancel_recommend' == type ) {
		var message = jQuery.i18n.prop("cancel_recommend_answer_tip");
		var url = 'forum.php?mod=misc&action=cancel_recommend_answer&tid=' + tid + '&pid=' + pid + '&from=' + from + '&cancel_recommend_answer_submit=yes';
	}

	showDialog(message, 'confirm', '', function () {
		$('modactions').action = url;
		$('modactions').submit();
	}, 0);

}

var authort;
function showauthor(ctrlObj, menuid) {
	authort = setTimeout(function () {
		showMenu({'menuid':menuid});
		if($(menuid + '_ma').innerHTML == '') $(menuid + '_ma').innerHTML = ctrlObj.innerHTML;
	}, 500);
	if(!ctrlObj.onmouseout) {
		ctrlObj.onmouseout = function() {
			clearTimeout(authort);
		}
	}
}

function fastpostappendreply() {
	if($('fastpostrefresh') != null) {
		setcookie('fastpostrefresh', $('fastpostrefresh').checked ? 1 : 0, 2592000);
		if($('fastpostrefresh').checked) {
			location.href = 'forum.php?mod=redirect&tid='+tid+'&goto=lastpost&random=' + Math.random() + '#lastpost';
			return;
		}
	}
	newpos = fetchOffset($('post_new'));
	document.documentElement.scrollTop = newpos['top'];
	$('post_new').style.display = '';
	$('post_new').id = '';
	div = document.createElement('div');
	div.id = 'post_new';
	div.style.display = 'none';
	div.className = 'viewthread_table';
	$('postlistreply').appendChild(div);

	if($('fastpostmessage')) {
		$('fastpostmessage').value = '';
	} else {
		editdoc.body.innerHTML = BROWSER.firefox ? '<br />' : '';
	}
    $('fastpostsubmit').disabled = false;

	if($('secanswer3')) {
		$('checksecanswer3').innerHTML = '<img src="' + STATICURL + 'image/common/none.gif" width="17" height="17">';
		$('secanswer3').value = '';
		secclick3['secanswer3'] = 0;
	}
	if($('seccodeverify3')) {
		$('checkseccodeverify3').innerHTML = '<img src="' + STATICURL + 'image/common/none.gif" width="17" height="17">';
		$('seccodeverify3').value = '';
		secclick3['seccodeverify3'] = 0;
	}

	var thisObj = jQuery('#postlistreply').children('.viewthread_table').eq(-2);
	if (thisObj.find('.post_message').height() >= 480) {
		thisObj.find('.viewthread_node_view_more').show();
	}
	showCreditPrompt();
	if(typeof lazy_start === "function"){
		lazy_start()
	};
}

function succeedhandle_fastpost(locationhref, message, param) {
	var pid = param['pid'];
	var tid = param['tid'];
	var from = param['from'];
	var lotteryid =  param['lotteryid'];
	var islottery =  param['islottery'];
	if(pid) {
		ajaxget('forum.php?mod=viewthread&tid=' + tid + '&viewpid=' + pid + '&from=' + from, 'post_new', 'ajaxwaitid', '', null, 'fastpostappendreply()');
		if(replyreload) {
			var reloadpids = replyreload.split(',');
			for(i = 1;i < reloadpids.length;i++) {
				ajaxget('forum.php?mod=viewthread&tid=' + tid + '&viewpid=' + reloadpids[i] + '&from=' + from, 'post_' + reloadpids[i], 'ajaxwaitid');
			}
		}
		$('fastpostreturn').className = '';
		$('fastpostreturn').innerHTML = '';
	} else {
		if(!message) {
			message = ''+jQuery.i18n.prop("forum_viewthread_252")+'';
		}
		$('post_new').style.display = $('fastpostmessage').value = $('fastpostreturn').className = '';
		$('fastpostreturn').innerHTML = message;
		errorhandle_fastpost()
	}
	if(param['sechash']) {
		updatesecqaa(param['sechash']);
		updateseccode(param['sechash']);
	}
	if($('attach_tblheader')) {
		$('attach_tblheader').style.display = 'none';
	}
	if($('trade_secret_box')) {
		$('trade_secret_box').style.display = 'none';
	}
	if($('attachlist')) {
		$('attachlist').innerHTML = '';
	}
	// MODIFY-LLS T3584 回复新增抽奖机会
	if( typeof (lotteryid) !='undefined' && typeof (islottery) !='undefined' && lotteryid!='' && islottery==1){
		showLotteryTip(lotteryid);
		setcookie('lotteryid','');
		setcookie('islottery',0);
	}
}

function errorhandle_fastpost() {
	$('fastpostsubmit').disabled = false;
}

function succeedhandle_comment(locationhref, message, param) {
	ajaxget('forum.php?mod=misc&action=commentmore&tid=' + param['tid'] + '&pid=' + param['pid'], 'comment_' + param['pid']);
	hideWindow('comment');
	showCreditPrompt();
}

function succeedhandle_postappend(locationhref, message, param) {
	ajaxget('forum.php?mod=viewthread&tid=' + param['tid'] + '&viewpid=' + param['pid'], 'post_' + param['pid'], 'ajaxwaitid');
	hideWindow('postappend');
}

function recommendupdate(n) {
	if(getcookie('recommend')) {
		var objv = n > 0 ? $('recommendv_add') : $('recommendv_subtract');
		objv.style.display = '';
		objv.innerHTML = parseInt(objv.innerHTML) + 1;
		//MODIFY-LDW esc赞显隐
		if(n>0){
			jQuery('.escforum #recommend_add').css("backgroundColor",'#999');
			jQuery('.escforum #somebody_thumbsup').hide();
			jQuery('.escforum #somebody_thumbs').show();
		}
		setTimeout(function () {
			$('recommentc').innerHTML = parseInt($('recommentc').innerHTML) + n;
			$('recommentv').style.display = 'none';
		}, 1000);
		setcookie('recommend', '');
	}
}

function postreviewupdate(pid, n) {
	var objv = n > 0 ? $('review_support_'+pid) : $('review_against_'+pid);
	objv.innerHTML = parseInt(objv.innerHTML ? objv.innerHTML : 0) + 1;
}

function favoriteupdate() {
	var obj = $('favoritenumber');
	obj.style.display = '';
	obj.innerHTML = parseInt(obj.innerHTML) + 1;
}

function switchrecommendv() {
	display('recommendv');
	display('recommendav');
}

function appendreply() {
	newpos = fetchOffset($('post_new'));
	document.documentElement.scrollTop = newpos['top'];
	$('post_new').style.display = '';
	$('post_new').id = '';
	div = document.createElement('div');
	div.id = 'post_new';
	div.style.display = 'none';
	div.className = '';
	$('postlistreply').appendChild(div);
	if($('postform')) {
		$('postform').replysubmit.disabled = false;
	}
	showCreditPrompt();
}

function poll_checkbox(obj) {
	if(obj.checked) {
		p++;
		for (var i = 0; i < $('poll').elements.length; i++) {
			var e = $('poll').elements[i];
			if(p == max_obj) {
				if(e.name.match('pollanswers') && !e.checked) {
					e.disabled = true;
				}
			}
		}
	} else {
		p--;
		for (var i = 0; i < $('poll').elements.length; i++) {
			var e = $('poll').elements[i];
			if(e.name.match('pollanswers') && e.disabled) {
				e.disabled = false;
			}
		}
	}
	$('pollsubmit').disabled = p <= max_obj && p > 0 ? false : true;
}

function itemdisable(i) {
	if($('itemt_' + i).className == 'z') {
		$('itemt_' + i).className = 'z xg1';
		$('itemc_' + i).value = '';
		itemset(i);
	} else {
		$('itemt_' + i).className = 'z';
		$('itemc_' + i).value = $('itemc_' + i).value > 0 ? $('itemc_' + i).value : 0;
	}
}
function itemop(i, v) {
	var h = v > 0 ? '-' + (v * 16) + 'px' : '0';
	$('item_' + i).style.backgroundPosition = '10px ' + h;
}
function itemclk(i, v) {
	$('itemc_' + i).value = v;
	$('itemt_' + i).className = 'z';
}
function itemset(i) {
	var v = $('itemc_' + i).value;
	var h = v > 0 ? '-' + (v * 16) + 'px' : '0';
	$('item_' + i).style.backgroundPosition = '10px ' + h;
}

function checkmgcmn(id) {
	if($('mgc_' + id) && !$('mgc_' + id + '_menu').getElementsByTagName('li').length) {
		$('mgc_' + id).innerHTML = '';
		$('mgc_' + id).style.display = 'none';
	}
}

function toggleRatelogCollapse(tarId, ctrlObj) {
	if($(tarId).className == 'rate') {
		$(tarId).className = 'rate rate_collapse';
		setcookie('ratecollapse', 1, 2592000);
		ctrlObj.innerHTML = ''+jQuery.i18n.prop("forum_viewthread_253")+'<i class="arrow_down"></i>';
	} else {
		$(tarId).className = 'rate';
		setcookie('ratecollapse', 0, -2592000);
		ctrlObj.innerHTML = ''+jQuery.i18n.prop("forum_viewthread_254")+'<i class="arrow_top"></i>';
	}
}

function copyThreadUrl(obj, bbname) {
	bbname = bbname || SITEURL;
	//setCopy($('thread_subject').innerHTML.replace(/&amp;/g, '&') + '\n' + obj.href + '\n' + '('+jQuery.i18n.prop("forum_viewthread_255")+': '+bbname+')' + '\n', ''+jQuery.i18n.prop("forum_viewthread_256")+'');
	setCopy(obj.href + '\n' , ''+jQuery.i18n.prop("forum_viewthread_256")+'');
	return false;
}

function replyNotice() {
	var newurl = 'forum.php?mod=misc&action=replynotice&tid=' + tid + '&op=';
	var replynotice = $('replynotice');
	var status = replynotice.getAttribute("status");
	if(status == 1) {
		replynotice.href = newurl + 'receive';
		replynotice.innerHTML = ''+jQuery.i18n.prop("forum_viewthread_257")+'';
		replynotice.setAttribute("status", 0);
	} else {
		replynotice.href = newurl + 'ignore';
		replynotice.innerHTML = ''+jQuery.i18n.prop("forum_viewthread_258")+'';
		replynotice.setAttribute("status", 1);
	}
}

var connect_share_loaded = 0;
function connect_share(connect_share_url, connect_uin) {
	if(parseInt(discuz_uid) <= 0) {
		return true;
	} else {
		if(connect_uin) {
			setTimeout(function () {
				if(!connect_share_loaded) {
					showDialog(''+jQuery.i18n.prop("forum_viewthread_259")+'', 'notice');
					$('append_parent').removeChild($('connect_load_js'));
				}
			}, 5000);
			connect_load(connect_share_url);
		} else {
			showDialog($('connect_share_unbind').innerHTML, 'info', jQuery.i18n.prop("key_bindqq"));
		}
		return false;
	}
}

function connect_load(src) {
	var e = document.createElement('script');
	e.type = "text/javascript";
	e.id = 'connect_load_js';
	e.src = src + '&_r=' + Math.random();
	e.async = true;
	$('append_parent').appendChild(e);
}

function connect_show_dialog(title, html, type) {
	var type = type ? type : 'info';
	showDialog(html, type, title, null, 0);
}

function connect_get_thread() {
	connect_thread_info.subject = $('connect_thread_title').value;
	if ($('postmessage_' + connect_thread_info.post_id)) {
		connect_thread_info.html_content = preg_replace(["'"], ['%27'], encodeURIComponent(preg_replace(['本帖最后由 .*? 于 .*? 编辑','&nbsp;','<em onclick="copycode\\(\\$\\(\'code0\'\\)\\);">'+jQuery.i18n.prop("forum_viewthread_260")+'</em>'], ['',' ', ''], $('postmessage_' + connect_thread_info.post_id).innerHTML)));
	}
	return connect_thread_info;
}

function lazyload(className) {
	var obj = this;
	lazyload.className = className;
	this.getOffset = function (el, isLeft) {
		var  retValue  = 0 ;
		while  (el != null ) {
			retValue  +=  el["offset" + (isLeft ? "Left" : "Top" )];
			el = el.offsetParent;
		}
		return  retValue;
	};
	this.initImages = function (ele) {
		lazyload.imgs = [];
		var eles = lazyload.className ? $C(lazyload.className, ele) : [document.body];
		for (var i = 0; i < eles.length; i++) {
			var imgs = eles[i].getElementsByTagName('IMG');
			for(var j = 0; j < imgs.length; j++) {
				if(imgs[j].getAttribute('file') && !imgs[j].getAttribute('lazyloaded')) {
					if(this.getOffset(imgs[j]) > document.documentElement.clientHeight) {
						lazyload.imgs.push(imgs[j]);
					} else {
						imgs[j].onload = function(){thumbImg(this);};
						imgs[j].setAttribute('src', imgs[j].getAttribute('file'));
						imgs[j].setAttribute('lazyloaded', 'true');
					}
				}
			}
		}
	};
	this.showImage = function() {
		this.initImages();
		if(!lazyload.imgs.length) return false;
		var imgs = [];
		var scrollTop = Math.max(document.documentElement.scrollTop , document.body.scrollTop);
		for (var i=0; i<lazyload.imgs.length; i++) {
			var img = lazyload.imgs[i];
			var offsetTop = this.getOffset(img);
			if (!img.getAttribute('lazyloaded') && offsetTop > document.documentElement.clientHeight && (offsetTop  - scrollTop < document.documentElement.clientHeight)) {
				var dom = document.createElement('div');
				var width = img.getAttribute('width') ? img.getAttribute('width') : 100;
				var height = img.getAttribute('height') ? img.getAttribute('height') : 100;
				dom.innerHTML = '<div style="width: '+width+'px; height: '+height+'px;background: url('+IMGDIR + '/loading.gif) no-repeat center center;"></div>';
				img.parentNode.insertBefore(dom.childNodes[0], img);
				img.onload = function () {
					if(!this.getAttribute('_load')) {
						this.setAttribute('_load', 1);
						this.style.width = this.style.height = '';
						this.parentNode.removeChild(this.previousSibling);
						if(this.getAttribute('lazyloadthumb')) {
							thumbImg(this);
						}
					}
				};
				img.style.width = img.style.height = '1px';
				img.setAttribute('src', img.getAttribute('file') ? img.getAttribute('file') : img.getAttribute('src'));
				img.setAttribute('lazyloaded', true);
			} else {
				imgs.push(img);
			}
		}
		lazyload.imgs = imgs;
		return true;
	};
	this.showImage();
	_attachEvent(window, 'scroll', function(){obj.showImage();});
}
function update_collection(){
	var obj = $('collectionnumber');
	sum = 1;
	obj.style.display = '';
	obj.innerText = parseInt(obj.innerText)+sum;
}
function display_blocked_post() {
	var movehiddendiv = (!$('hiddenposts').innerHTML) ? true : false;
	for (var i = 0; i < blockedPIDs.length; i++) {
		if(movehiddendiv) {
			$('hiddenposts').appendChild($("post_"+blockedPIDs[i]));
		}
		display("post_"+blockedPIDs[i]);
	}
	var postlistreply = $('postlistreply').innerHTML;
	$('hiddenpoststip').parentNode.removeChild($('postlistreply'));
	$('hiddenpoststip').parentNode.removeChild($('hiddenpoststip'));
	$('hiddenposts').innerHTML+='<div id="postlistreply" class="pl">'+postlistreply+'</div>';
}

function show_threadpage(pid, current, maxpage, ispreview) {
	if(!$('threadpage') || typeof tid == 'undefined') {
		return;
	};
	var clickvalue = function (page) {
		return 'ajaxget(\'forum.php?mod=viewthread&tid=' + tid + '&viewpid=' + pid + '&cp=' + page + (ispreview ? '&from=preview' : '') + '\', \'post_' + pid + '\', \'ajaxwaitid\');';
	};
	var pstart = current - 1;
	pstart = pstart < 1 ? 1 : pstart;
	var pend = current + 1;
	pend = pend > maxpage ? maxpage : pend;
	var s = '<div class="cm pgs mtm mbm cl"><div class="pg">';
	if(pstart > 1) {
		s += '<a href="javascript:;" onclick="' + clickvalue(1) + '">1 ...</a>';
	}
	for(i = pstart;i <= pend;i++) {
		s += i == current ? '<strong>' + i + '</strong>' : '<a href="javascript:;" onclick="' + clickvalue(i)+ '">' + i + '</a>';
	}
	if(pend < maxpage) {
		s += '<a href="javascript:;" onclick="' + clickvalue(maxpage)+ '">... ' + maxpage + '</a>';
	}
	if(current < maxpage) {
		s += '<a href="javascript:;" onclick="' + clickvalue(current + 1) + '" class="nxt">'+jQuery.i18n.prop("forum_viewthread_261")+'</a>';
	}
	s += '<a href="javascript:;" onclick="' + clickvalue('all') + '">'+jQuery.i18n.prop("forum_viewthread_262")+'</a>';
	s += '</div></div>';
	$('threadpage').innerHTML = s;
}

var show_threadindex_data = '';
function show_threadindex(pid, ispreview) {
	if(!show_threadindex_data) {
		var s = '<div class="tindex"><h3>'+jQuery.i18n.prop("forum_viewthread_263")+'</h3><ul>';
		for(i in $('threadindex').childNodes) {
			o = $('threadindex').childNodes[i];
			if(o.tagName == 'A') {
				var sub = o.getAttribute('sub').length * 2;
				o.href = "javascript:;";
				if(o.getAttribute('page')) {
					s += '<li style="margin-left:' + sub + 'em" onclick="ajaxget(\'forum.php?mod=viewthread&threadindex=yes&tid=' + tid + '&viewpid=' + pid + '&cp=' + o.getAttribute('page') + (ispreview ? '&from=preview' : '') + '\', \'post_' + pid + '\', \'ajaxwaitid\')">' + o.innerHTML + '</li>';
				} else if(o.getAttribute('tid') && o.getAttribute('pid')) {
					s += '<li style="margin-left:' + sub + 'em" onclick="ajaxget(\'forum.php?mod=viewthread&threadindex=yes&tid=' + o.getAttribute('tid') + '&viewpid=' + o.getAttribute('pid') + (ispreview ? '&from=preview' : '') + '\', \'post_' + pid + '\', \'ajaxwaitid\')">' + o.innerHTML + '</li>';
				}
			}
		}
		s += '</ul></div>';
		$('threadindex').innerHTML = s;
		show_threadindex_data = s;
	} else {
		$('threadindex').innerHTML = show_threadindex_data;
	}
}
function ctrlLeftInfo(sli_staticnum) {
	var sli = $('scrollleftinfo');
	var postlist_bottom = parseInt($('postlist').getBoundingClientRect().bottom);
	var sli_bottom = parseInt(sli.getBoundingClientRect().bottom);
	if(postlist_bottom < sli_staticnum && postlist_bottom != sli_bottom) {
		sli.style.top = (postlist_bottom - sli.offsetHeight - 5)+'px';
	} else{
		sli.style.top = 'auto';
	}
}

function fixed_avatar(pids, fixednv) {
	var fixedtopnv = fixednv ? new fixed_top_nv('nv', true) : false;
	if(fixednv) {
		fixedtopnv.init();
	}
	function fixedavatar(e) {
		var avatartop = fixednv ? fixedtopnv.run() : 0;
		for(var i = 0; i < pids.length; i++) {
			var pid = pids[i];
			var posttable = $('pid'+pid);
			var postavatar = $('favatar'+pid);
			if(!$('favatar'+pid)) {
				return;
			}
			var nextpost = $('_postposition'+pid);
			if(!postavatar || !nextpost || posttable.offsetHeight - 100 < postavatar.offsetHeight) {
				if(postavatar.style.position == 'fixed') {
					postavatar.style.position = '';
				}
				continue;
			}
			var avatarstyle = postavatar.style;
			posttabletop = parseInt(posttable.getBoundingClientRect().top);
			nextposttop = parseInt(nextpost.getBoundingClientRect().top);
			if(nextposttop > 0 && nextposttop <= postavatar.offsetHeight) {
				if(BROWSER.firefox) {
					if(avatarstyle.position != 'fixed') {
						avatarstyle.position = 'fixed';
					}
					avatarstyle.top = -(postavatar.offsetHeight - nextposttop)+'px';
				} else {
					postavatar.parentNode.style.position = 'relative';
					avatarstyle.top = '';
					avatarstyle.bottom = '0px';
					avatarstyle.position = 'absolute';
				}
			} else if(posttabletop < 0 && nextposttop > 0) {
				if(postavatar.parentNode.style.position != '') {
					postavatar.parentNode.style.position = '';
				}
				if(avatarstyle.position != 'fixed' || parseInt(avatarstyle.top) != avatartop) {
					avatarstyle.bottom = '';
					avatarstyle.top = avatartop + 'px';
					avatarstyle.position = 'fixed';
				}
			} else if(avatarstyle.position != '') {
				avatarstyle.position = '';
			}
		}
	}
	if(!(BROWSER.ie && BROWSER.ie < 7)) {
		_attachEvent(window, 'load', function(){_attachEvent(window, 'scroll', fixedavatar);});
	}
}

function threadbegindisplay(type, w, h, s) {

	$('begincloseid').onclick = function() {
		$('threadbeginid').style.display = 'none';
	};
	var imgobj = $('threadbeginid');
	imgobj.style.left = (document.body.clientWidth - w)/2 + 'px';
	imgobj.style.top = (document.body.clientHeight - h)/2 + 'px';
	if(type == 1) {
		autozoom(w, h, s);
	} else if(type == 2) {
		autofade(w, h, s);
	} else {
		setTimeout(function() {
			$('threadbeginid').style.display = 'none';
		}, s);
	}
}

function autofade(w, h, s) {
	this.imgobj = $('threadbeginid');
	this.opacity = 0;
	this.fadein = function() {
		if(BROWSER.ie) {
			this.imgobj.filters.alpha.opacity = this.opacity;
		} else {
			this.imgobj.style.opacity = this.opacity/100;
		}
		if(this.opacity >= 100) {
			setTimeout(this.fadeout, s);
			return;
		}
		this.opacity++;
		setTimeout(this.fadein, 50);
	};
	this.fadeout = function() {
		if(BROWSER.ie) {
			this.imgobj.filters.alpha.opacity = this.opacity;
		} else {
			this.imgobj.style.opacity = this.opacity/100;
		}
		if(this.opacity <= 0) {
			this.imgobj.style.display = 'none';
			return;
		}
		this.opacity--;
		setTimeout(this.fadeout, 50);
	};
	this.fadein();
}

function autozoom(w, h, s) {
	this.height = 0;
	this.imgobj = $('threadbeginid');
	this.imgobj.style.overflow = 'hidden';
	this.imgobj.style.display = '';
	this.autozoomin = function() {
		this.height += 5;
		if(this.height >= h) {
			this.imgobj.style.height = h + 'px';
			setTimeout(this.autozoomout, s);
			return;
		}
		this.imgobj.style.height = this.height + 'px';
		setTimeout(this.autozoomin, 50);
	};
	this.autozoomout = function() {
		this.height -= 5;
		if(this.height <= 0) {
			this.imgobj.style.height = 0 + 'px';
			this.imgobj.style.display = 'none';
			return;
		}
		this.imgobj.style.height = this.height + 'px';
		setTimeout(this.autozoomout, 50);
	};
	this.autozoomin();
}

function readmode(title, pid) {

	var imagelist = '';
	if(aimgcount[pid]) {
		for(var i = 0; i < aimgcount[pid].length;i++) {
			var aimgObj = $('aimg_'+aimgcount[pid][i]);
			if(aimgObj.parentElement.className!="mbn") {
				var src = aimgObj.getAttribute('file');
				imagelist += '<div class="mbn"><img src="' + src + '" width="600" /></div>';
			}
		}
	}
	msg = $('postmessage_'+pid).innerHTML+imagelist;
	msg = '<div style="width:800px;max-height:500px; overflow-y:auto; padding: 10px;" class="pcb">'+msg+'</div>';
	showDialog(msg, 'info', title, null, 1);
	var coverObj = $('fwin_dialog_cover');
	coverObj.style.filter = 'progid:DXImageTransform.Microsoft.Alpha(opacity=90)';
	coverObj.style.opacity = 0.9;
}

function changecontentdivid(tid) {
	if($('postlistreply')) {
		objtid = $('postlistreply').getAttribute('tid');
		if(objtid == tid) {
			return;
		}
		$('postlistreply').id = 'postlistreply_'+objtid;
		postnewdiv = $('postlistreply_'+objtid).childNodes;
		postnewdiv[postnewdiv.length-1].id = 'post_new_'+objtid;
	}
	$('postlistreply_'+tid).id = 'postlistreply';
	postnewdiv = $('postlistreply').childNodes;
	postnewdiv[postnewdiv.length-1].id = 'post_new';
}
function showmobilebbs(obj) {
	var content = '<h3 class="flb" style="cursor:move;"><em>'+jQuery.i18n.prop("forum_viewthread_264")+'</em><span><a href="javascript:;" class="flbc" onclick="hideWindow(\'mobilebbs\')" title="{lang close}">{lang close}</a></span></h3><div class="c"><h4>Andriod'+jQuery.i18n.prop("forum_viewthread_265")+'</h4><p class="mtm mbm vm"><span class="code_bg"><img src="'+ STATICURL +'image/common/zslt_andriod.png" alt="" /></span><img src="'+ STATICURL +'image/common/andriod.png" alt="'+jQuery.i18n.prop("key_phone")+'" /></p><h4>iPhone'+jQuery.i18n.prop("forum_viewthread_265")+'</h4><p class="mtm mbm vm"><span class="code_bg"><img src="'+ STATICURL +'image/common/zslt_ios.png" alt="" /></span><img src="'+ STATICURL +'image/common/ios.png" alt="'+jQuery.i18n.prop("forum_viewthread_266")+'" /></p></div>';
	showWindow('mobilebbs', content, 'html');
}
function submitPool(pid) {
	ajaxpost('poll', pid, pid);
	return false;
}
// MODIFY-LLS T8824
function changeProblemStatus(tid, status) {
	if (BROWSER.ie) {
		doane(event);
	}
	if ( status == 0 ) {
		var message = jQuery.i18n.prop("change_problem_status_unsolved_tip");
	} else if ( status == 1 ) {
		var message = jQuery.i18n.prop("change_problem_status_solved_tip");
	}
	var url = 'forum.php?mod=misc&action=changeproblemstatus' +
		'&tid=' + tid +'&status='+status+'&recommend_answer_submit=yes';

	showDialog(jQuery.i18n.prop(message), 'confirm', '', function () {
		$('modactions').action = url;
		$('modactions').submit();
	}, 0);

}

function commentToggle(objId, showMoreText, FoldText) {
	var postNode = jQuery(objId);
	var commentHeight = postNode.find('.post_message').height();
	if (commentHeight > 480) {
		postNode.find('.post_message').css('max-height', '480px');
		postNode.find('.viewthread_node_mask').show();
		postNode.find('.viewmore-toggle').text(showMoreText);
		postNode.find('.viewthread_node_arrow').removeClass('icon-Arrow-fold');
		jQuery('html,body').animate({scrollTop:postNode.offset().top},500)
	} else {
		postNode.find('.post_message').css('max-height', 'none');
		postNode.find('.viewthread_node_mask').hide();
		postNode.find('.viewmore-toggle').text(FoldText);
		postNode.find('.viewthread_node_arrow').addClass('icon-Arrow-fold');
	}

}

function httpAjax( type, url, data, func ) {
	jQuery.support.cors = true;
	jQuery.ajax({
		type:type,
		url: url,
		cache:false,
		dataType:'json',
		data:data,
		xhrFields: {
			withCredentials: true
		},
		success:function (res) {
			func(res);
		}
	});
}
// 点赞
function esc_recommend_add( obj, objectType, objectId, isEscEn, type ) {
	if ( type == 'addRecommend' ) {
		var url = SITEURL + 'api/thread/recommend?type=recommend';
		var num = 1;
	} else {
		var url = SITEURL + 'api/thread/recommend?type=cancelRecommend';
		var num = -1;
	}
	var data = '';
	if ( 5 == objectType ) {
		data = '{"objectType":' + objectType + ',"topicId":' + objectId + ',"formhash":"' + FORMHASH + '","attitude":1}';
	} else if ( 6 == objectType ) {
		data = '{"objectType":' + objectType + ',"postId":' + objectId + ',"formhash":"' + FORMHASH + '","attitude":1}';
	} else if ( 7 == objectType ) {
		data = '{"objectType":' + objectType + ',"pcid":' + objectId + ',"formhash":"' + FORMHASH + '","attitude":1}';
	}
	var $obj = jQuery(obj);
	var recommend_add_callback = function(res) {
		if ( res.success == "true" ) {
			if ( 5 == objectType ) {    // 点赞主题帖
				$obj.find('#recommendv_add').text(function(index,oldcontent) {
					return parseInt(oldcontent) + num;
				});
				if( isEscEn === undefined ){
					$obj.find('#somebody_thumbsup').css('display', 'none');
					$obj.find('#somebody_thumbs').css('display', 'inline');
					$obj.css('background-color', '#999');
				}else if ( isEscEn == 1) {
					$obj.find('.icon-wenti').css('color', '#E50000');
					$obj.find('.h').css('color', '#E50000');
					$obj.find('.bractet').css('color', '#E50000');
					$obj.find('#recommendv_add').css('color', '#E50000');
				}else if ( isEscEn == 2 ){
					if ( type == 'addRecommend' ) {
						$obj.find('.icon-line-likes').addClass('icon-solid-likes');
						$obj.find('.icon-solid-likes').removeClass('icon-line-likes');
						$obj.find('.icon-solid-likes').css('color', '#E50000');
						$obj.find('.h').css('color', '#E50000');
						$obj.find('.bractet').css('color', '#E50000');
						$obj.find('#recommendv_add').css('color', '#E50000');
						$obj.find('#recommendv_add').removeClass('likes-em');
						jQuery("#recommend_sub").addClass("like-oked");
						jQuery("#recommend_sub").addClass("floor-like");
						jQuery("#recommend_sub").removeAttr('onclick');
						jQuery("#recommend_sub").off('click');
					} else {
						$obj.find('.icon-solid-likes').addClass('icon-line-likes');
						$obj.find('.icon-line-likes').removeClass('icon-solid-likes');
						$obj.find('.icon-line-likes').css('color', '#333');
						$obj.find('.h').css('color', '#333');
						$obj.find('.bractet').css('color', '#333');
						$obj.find('#recommendv_add').css('color', '#333');
						$obj.find('#recommendv_add').addClass('likes-em');
						jQuery('#recommend_sub').removeClass('like-oked');
						jQuery("#recommend_sub").removeClass("floor-like");
						jQuery("#recommend_sub").on('click',function(){
							esc_recommend_sub( jQuery("#recommend_sub").get(0), objectType, objectId, isEscEn, 'addRecommend' );
							return false;
						})
					}

				}
			} else if ( 6 == objectType ) { // 点赞回复
				$obj.find('.review_support_' + objectId).text(function(index,oldcontent) {
					return parseInt(oldcontent) + num;
				});
				if ( type == 'addRecommend' ) {
					$obj.find("span").css('color','#E50000');
					$obj.find('.icon-line-likes').addClass('icon-solid-likes');
					$obj.find('.icon-solid-likes').removeClass('icon-line-likes');
					$obj.find('.icon-solid-likes').css('color', '#E50000');
					$obj.next("a").addClass("like-oked");
					$obj.next("a").addClass("floor-like");
					$obj.find('.review_support_' + objectId).css('color','#E50000');
					$obj.find('.review_support_' + objectId).removeClass('likes-em');
					$obj.next("a").removeAttr('onclick');
					$obj.next("a").off('click');
				} else {
					$obj.css('color','#333');
					$obj.find("span").css('color','#333');
					$obj.find('.icon-solid-likes').addClass('icon-line-likes');
					$obj.find('.icon-line-likes').removeClass('icon-solid-likes');
					$obj.find('.icon-line-likes').css('color', '#333');
					$obj.find('.review_support_' + objectId).css('color','#333');
					$obj.find('.review_support_' + objectId).addClass('likes-em');
					$obj.next("a").removeClass("like-oked");
					$obj.next("a").removeClass("floor-like");
					$obj.next("a").on('click',function(){
						esc_recommend_sub( $obj.next("a").get(0), objectType, objectId, isEscEn, 'addRecommend' );
						return false;
					})
				}

			} else if ( 7 == objectType ) { // 点评点赞
				$obj.find('.review_support_' + objectId).text(function(index,oldcontent) {
					return parseInt(oldcontent) + num;
				});
				if ( type == 'addRecommend' ) {
					$obj.find("span").css('color','#E50000');
					$obj.find('.icon-line-likes').addClass('icon-solid-likes');
					$obj.find('.icon-solid-likes').removeClass('icon-line-likes');
					$obj.find('.icon-solid-likes').css('color', '#E50000');
					$obj.next("a").addClass("like-oked");
					$obj.next("a").addClass("floor-like");
					$obj.next("a").removeAttr('onclick');
					$obj.next("a").off('click');
				} else {
					$obj.css('color','#999');
					$obj.find("span").css('color','#999');
					$obj.find('.icon-solid-likes').addClass('icon-line-likes');
					$obj.find('.icon-line-likes').removeClass('icon-solid-likes');
					$obj.find('.icon-line-likes').css('color', '#333');
					$obj.next("a").removeClass("like-oked");
					$obj.next("a").removeClass("floor-like");
					$obj.next("a").on('click',function(){
						esc_recommend_sub( $obj.next("a").get(0), objectType, objectId, isEscEn, 'addRecommend' );
						return false;
					})
				}
			}
			showCreditPrompt();
			$obj.on('click',function(){
				esc_recommend_add( obj, objectType, objectId, isEscEn, ( type == 'addRecommend') ? 'cancelRecommend':'addRecommend');
				return false;
			})
		} else {
			showError(res.message);
			$obj.on('click',function(){
				esc_recommend_add( obj, objectType, objectId, isEscEn, type );
				return false;
			})
		}
	};
	$obj.removeAttr('onclick');
	$obj.off('click');
	if ( 5 == objectType ) {
		jQuery('#recommend_sub').off("click").removeAttr('onclick');
	} else {
		$obj.next("a").off("click").removeAttr('onclick');
	}
	httpAjax( 'post', url, data, recommend_add_callback );
}

// 点踩
function esc_recommend_sub( obj, objectType, objectId , isEscEn, type ) {
	if ( type == 'addRecommend' ) {
		var url = SITEURL + '/enterprise/api/thread/recommend?type=recommend';
		var attitude=0;
		var num = 1;
	} else {
		var url = SITEURL + '/enterprise/api/thread/recommend?type=cancelRecommend';
		var attitude=1;
		var num = -1;
	}
	var data = '';
	if ( 5 == objectType ) {
		data = '{"objectType":' + objectType + ',"topicId":' + objectId + ',"formhash":"' + FORMHASH + '","attitude":0}';
	} else if ( 6 == objectType ){
		data = '{"objectType":' + objectType + ',"postId":' + objectId + ',"formhash":"' + FORMHASH + '","attitude":0}';
	}else if ( 7 == objectType ){
		data = '{"objectType":' + objectType + ',"pcid":' + objectId + ',"formhash":"' + FORMHASH + '","attitude":0}';
	}
	var $obj = jQuery(obj);
	var recommend_sub_callback = function(res) {
		if ( res.success == "true" ) {
			if ( 5 == objectType ) {    // 点踩主题帖
				$obj.find('#recommendv_sub').text(function(index,oldcontent) {
					return parseInt(oldcontent) + num;
				});
				if( isEscEn === undefined ){
					$obj.find('#somebody_thumbsup').css('display', 'none');
					$obj.find('#somebody_thumbs').css('display', 'inline');
					$obj.css('background-color', '#999');
				}else if ( isEscEn == 1) {
					$obj.find('.icon-wenti').css('color', '#E50000');
					$obj.find('.h').css('color', '#E50000');
					$obj.find('.bractet').css('color', '#E50000');
					$obj.find('#recommendv_add').css('color', '#E50000');
				}else if ( isEscEn == 2 ){
					if ( type == 'addRecommend' ) {
						$obj.find('.icon-line-steps').addClass('icon-solid-steps');
						$obj.find('.icon-solid-steps').removeClass('icon-line-steps');
						$obj.find('.icon-solid-steps').css('color', '#E50000');
						$obj.find('.h').css('color', '#E50000');
						$obj.find('.bractet').css('color', '#E50000');
						$obj.find('#recommendv_sub').css('color', '#E50000');
						jQuery("#recommend_add").addClass("like-oked");
						jQuery("#recommend_add").addClass("floor-like");
						jQuery("#recommend_add").removeAttr('onclick');
						jQuery("#recommend_add").off('click');
					} else {
						$obj.find('.icon-solid-steps').addClass('icon-line-steps');
						$obj.find('.icon-line-steps').removeClass('icon-solid-steps');
						$obj.find('.icon-line-steps').css('color', '#333');
						$obj.find('.h').css('color', '#333');
						$obj.find('.bractet').css('color', '#333');
						$obj.find('#recommendv_sub').css('color', '#333');
						jQuery("#recommend_add").removeClass("like-oked");
						jQuery("#recommend_add").removeClass("floor-like");
						jQuery("#recommend_add").on('click',function(){
							esc_recommend_add( jQuery("#recommend_add").get(0), objectType, objectId, isEscEn, 'addRecommend' );
							return false;
						})
					}
				}
			} else if ( 6 == objectType ) { // 点踩回复
				$obj.find('.review_against_' + objectId).text(function(index,oldcontent) {
					return parseInt(oldcontent) + num;
				});

				if ( type == 'addRecommend' ) {
					$obj.find("span").css('color','#E50000');
					$obj.find('.icon-line-steps').addClass('icon-solid-steps');
					$obj.find('.icon-solid-steps').removeClass('icon-line-steps');
					$obj.find('.icon-solid-steps').css('color', '#E50000');
					$obj.prev("a").addClass("like-oked").addClass("floor-like");
					$obj.prev("a").removeAttr('onclick');
					$obj.prev("a").off('click');
				} else {
					$obj.css('color','#333');
					$obj.find("span").css('color','#333');
					$obj.find('.icon-solid-steps').addClass('icon-line-steps');
					$obj.find('.icon-line-steps').removeClass('icon-solid-steps');
					$obj.find('.icon-line-steps').css('color', '#333');
					$obj.prev("a").removeClass("like-oked").removeClass("floor-like");
					$obj.prev("a").on('click',function(){
						esc_recommend_add( $obj.prev("a").get(0), objectType, objectId, isEscEn, 'addRecommend' );
						return false;
					})
				}

			} else if( 7 == objectType ) { //点评点踩/取消踩
				$obj.find('.review_against_' + objectId).text(function(index,oldcontent) {
					return parseInt(oldcontent) + num;
				});
				if ( type == 'addRecommend' ) {
					$obj.find("span").css('color','#E50000');
					$obj.find('.icon-line-steps').addClass('icon-solid-steps');
					$obj.find('.icon-solid-steps').removeClass('icon-line-steps');
					$obj.find('.icon-solid-steps').css('color', '#E50000');
					$obj.prev("a").addClass("like-oked").addClass("floor-like");
					$obj.prev("a").removeAttr('onclick');
					$obj.prev("a").off('click');
				} else {
					$obj.css('color','#333');
					$obj.find("span").css('color','#333');
					$obj.find('.icon-solid-steps').addClass('icon-line-steps');
					$obj.find('.icon-line-steps').removeClass('icon-solid-steps');
					$obj.find('.icon-line-steps').css('color', '#333');
					$obj.prev("a").removeClass("like-oked").removeClass("floor-like");
					$obj.prev("a").on('click',function(){
						esc_recommend_add( $obj.prev("a").get(0), objectType, objectId, isEscEn, 'addRecommend' );
						return false;
					})
				}
			}
			showCreditPrompt();
			$obj.on('click',function(){
				esc_recommend_sub( obj, objectType, objectId, isEscEn, ( type == 'addRecommend') ? 'cancelRecommend':'addRecommend' );
				return false;
			})
		} else {
			showError(res.message);
			$obj.on('click',function(){
				esc_recommend_sub( obj, objectType, objectId, isEscEn, type );
				return false;
			})
		}
	};
	$obj.removeAttr('onclick');
	$obj.off('click');
	if ( 5 == objectType ) {
		jQuery("#p_btn").find("a:eq(0)").off("click").removeAttr('onclick');
	} else {
		$obj.prev("a").off("click").removeAttr('onclick');
	}
	httpAjax( 'post', url, data, recommend_sub_callback );
}
// 点赞
function recommend_add( obj, objectType, objectId , isEscEn ) {
	var url = SITEURL + '/enterprise/api/thread/recommend';
	var data = '';
	if ( 5 == objectType ) {
		data = '{"objectType":' + objectType + ',"topicId":' + objectId + ',"formhash":"' + FORMHASH + '"}';
	} else {
		data = '{"objectType":' + objectType + ',"postId":' + objectId + ',"formhash":"' + FORMHASH + '"}';
	}
	var $obj = jQuery(obj);
	var recommend_add_callback = function(res) {
		if ( res.success == "true" ) {
			if ( 5 == objectType ) {    // 点赞主题帖
				$obj.find('#recommendv_add').text(function(index,oldcontent) {
					return parseInt(oldcontent) + 1;
				});
				if( isEscEn === undefined ){
					$obj.find('#somebody_thumbsup').css('display', 'none');
					$obj.find('#somebody_thumbs').css('display', 'inline');
					$obj.css('background-color', '#999');
				}else if ( isEscEn == 1) {
					$obj.find('.icon-wenti').css('color', '#E50000');
					$obj.find('.h').css('color', '#E50000');
					$obj.find('.bractet').css('color', '#E50000');
					$obj.find('#recommendv_add').css('color', '#E50000');
				}else if ( isEscEn == 2 ){
					$obj.find('.icon-heart').addClass('icon-heart1');
					$obj.find('.icon-heart1').removeClass('icon-heart');
					$obj.find('.icon-heart1').css('color', '#E50000');
					$obj.find('.h').css('color', '#E50000');
					$obj.find('.bractet').css('color', '#E50000');
					$obj.find('#recommendv_add').css('color', '#E50000');
				}
			} else if ( 6 == objectType ) { // 点赞回复
				$obj.prev('a').find('.review_support_' + objectId).text(function(index,oldcontent) {
					return parseInt(oldcontent) + 1;
				});
				$obj.css('display', 'none');
				$obj.prev('a').css('display', 'inline');
				if( isEscEn === undefined ){
					$obj.parent().children('i.floor-img-like').removeClass('icon_support01').addClass('icon_support03');
				}
				var ojbs = jQuery('.floor-no-like-'+objectId);
				ojbs.each(function(k, v) {
					var item = jQuery(v);
					if (!item.is($obj)) {
						item.prev('a').find('.review_support_' + objectId).text(function(index,oldcontent) {
							return parseInt(oldcontent) + 1;
						});
						item.css('display', 'none');
						item.prev('a').css('display', 'inline');
						if( isEscEn === undefined ){
							$obj.parent().children('i.floor-img-like').removeClass('icon_support01').addClass('icon_support03');
						}
					}
				})
			}
			showCreditPrompt();
		} else {
			showError(res.message);
		}
	};
	httpAjax( 'post', url, data, recommend_add_callback );
}

// 获取情绪调研数据
function getObjectEmotionSurveyNum(red,objectId,objectType){
	jQuery.ajax({
		type : "POST",
		//请求地址
		url : "forum.php?mod=emotionSurvey",
		//数据，json字符串
		data : {
			"action": "getObjectEmotionSurveyNum",
			"objectId": objectId,
			"objectType": objectType
		},
		dataType:'json',
		async: false,
		//请求成功
		success : function(result) {
			if ( result.code === '0000' ) {
				if ( objectType == 'thread' ) {
					jQuery("#managecontent"+red).find(".emotion_survey_num").text(result.data);
				} else if ( objectType == 'post' ) {
					jQuery("#managecontent"+red).find(".emotion_survey_num").text(result.data);
				} else if ( objectType == 'comment' ) {
					jQuery("#managecontent_comment"+red).find(".emotion_survey_num").text(result.data);
				}
			}
		},
		//请求失败，包含具体的错误信息
		error : function(e){

		}
	})
}
// 新增情绪调研
function addEmotionSurvey(objectId,objectType,formhash){
	jQuery.ajax({
		type: "POST",
		//请求地址
		url: "forum.php?mod=emotionSurvey",
		//数据，json字符串
		data: {
			"action": "addEmotionSurvey",
			"objectId": objectId,
			"objectType": objectType,
			"type": jQuery(".emotion_type").val(),
			"descriptions": jQuery(".descriptions").val(),
			'formhash': formhash,
		},
		dataType: 'json',
		//请求成功
		success: function (result) {
			if (result.code === '0000') {
				jQuery(".emotion_survey").remove();
				jQuery(".emotion-popDivLayer").remove();
			} else {
				showDialog(result.message);
			}
		},
		//请求失败，包含具体的错误信息
		error: function (e) {
			showDialog(jQuery.i18n.prop("send_network_false"));
		}
	})
}
// 关闭情绪调研弹出框
function closeEmotionSurvey(obj) {
	jQuery(".emotion-popDivLayer").remove();
	jQuery(".emotion_survey").remove();
}
var realLabelsHtml = '';
jQuery(function () {
	var isAbleToEdit = false;
	jQuery(".label-item-list").on("click", '.ptg-label-icon', function(e){
		jQuery(this).parent().remove();
	});
	jQuery(".label-item-box .label-item-list").on("click", '#label-select-box-ul li', function(e){
		e.stopPropagation();
		var $this = jQuery(this);
		var id = $this.data('id');
		var label = $this.children('span').text();
		var parentLabel = $this.parent().parent().children('span').text();
		if (parentLabel) {
			parentLabel = parentLabel + ' / ';
		}
		if ($this.hasClass('selected')) {
			jQuery('#label-item-' + id).remove();
			$this.removeClass('selected');
		} else {
			jQuery('.label-item-list #label-float').before("<span id='label-item-" + id + "' class='ptg-label label-item' title='" + parentLabel + label + "' data-id='" + id + "'>" + parentLabel + label + "<i class='icon iconfont icon-delete ptg-label-icon'></i></span>");
			$this.addClass('selected');
		}
		closeLabelFloat()
	});

	jQuery("#label-button-edit").click(function (e) {
		saveRealLabels();
		jQuery('.ptg .label-item-list').css('border-color', '#DDD').addClass('label-edit');
		jQuery(this).hide();
		jQuery('#label-button-cancel').show();
		jQuery('#label-button-save').show();
		isAbleToEdit = true;
		ajaxGetAllLabels(fid);
	});

	jQuery("#label-button-cancel").click(function (e) {
		endEdit();
		setRealLabels();
		isAbleToEdit = false;
	});

	jQuery("#label-button-save").click(function (e) {
		var labels = getSelectLabelIds();
		jQuery.ajax({
			type: 'post',
			url: 'api/labels/postthreadlabels',
			data: {tid: tid, label_id: labels},
			async: true,
			success: function (result) {
				if (result.code === '0000') {

				} else {
					newAlertTips(result.message, '', 1500, 'new_alert_error')
				}
			}
		});
		endEdit();
		isAbleToEdit = false;
	});

	jQuery('.label-item-list').click(function (e) {
		if (jQuery(e.target).hasClass('label-item-list') && isAbleToEdit === true) {
			if (jQuery('.label-item-list .label-item').length < 10) {
				jQuery('#label-float').css('display', 'inline-block');
				jQuery('.label-item-add').val('').focus();
				jQuery('.label-item-list').css('border-color', '#E93342');
			}
		}
	});
	jQuery('.label-item-add').blur(function (e) {
		closeLabelFloat()
	});

});

function getSelectLabelIds() {
	var selectedIds = [];
	jQuery('.label-item-list .label-item').each(function (k, v){
		selectedIds[k] = jQuery(v).data('id');
	});
	return selectedIds;
}

function closeLabelFloat() {
	jQuery('#label-float').hide();
	jQuery('.ptg .label-item-list').css('border-color', '#DDD');
}

function ajaxGetAllLabels(fid) {
	jQuery.ajax({
		type: 'get',
		url: 'api/labels',
		data: {fid: fid, label_id: -1},
		async: true,
		success: function (result) {
			if (result.code === '0000') {
				var ulObj = jQuery('.label-select-box #label-select-box-ul');
				ulObj.html('');
				var subIcon = '<i class="icon iconfont icon-youjiantou"></i>';
				var checkIcon = '<i class="icon iconfont icon-checkmark"></i>';//
				var ids = getSelectLabelIds();
				var ul ='';
				jQuery.each(result.data, function (k, v) {
					var li = '<li'+ (ids.indexOf(parseInt(v.id)) >= 0 ? ' class="selected"' : ' ') +' data-id="' + v.id + '"><span>' + checkIcon + v.label + '</span>';
					if (typeof(v.children) !== 'undefined' && v.children.length > 0) {
						li = li + subIcon + '<ul class="label-select-box-ul-sub">';
						jQuery.each (v.children, function (key, value) {
							li = li + '<li' + (ids.indexOf(parseInt(value.id)) >= 0 ? ' class="selected"' : ' ') + ' data-id="' + value.id + '"><span>' +  checkIcon + value.label + '</span></li>'
						});
						li = li + '</ul>';
					}
					li += '</li>';
					ul += li;
				});
				ulObj.append(ul);
				JQ( "#label-select-box-ul" ).menu("refresh");
				JQ('.label-select-box').show();
			} else {
				newAlertTips(result.message, '', 1500, 'new_alert_error')
			}
		}
	});
}

function endEdit() {
	jQuery('.ptg .label-item-list').css('border-color', '#FFF').removeClass('label-edit');
	jQuery(this).hide();
	jQuery('#label-button-edit').show();
	jQuery('#label-button-save').hide();
	jQuery('#label-button-cancel').hide();
}

function saveRealLabels() {
	realLabelsHtml = '';
	var labelItems = jQuery('.label-item-box .label-item-list .label-item');
	jQuery.each(labelItems, function (k, item) {
		realLabelsHtml = realLabelsHtml + item.outerHTML;
	});
}

function setRealLabels() {
	jQuery('.label-item-box .label-item-list .label-item').remove();
	jQuery('.label-item-box .label-item-list #label-float').before(realLabelsHtml);
	jQuery( "#label-select-box-ul").menu();
}

function ajaxGetRecommendThread(fid, tid) {
	var ulObj = jQuery('.content-right .recommend');
	if (ulObj.length === 0) {
		return false;
	}
	jQuery.ajax({
		type: 'get',
		url: 'api/thread/threadDetailRecommend',
		data: {fid: fid, tid: tid},
		async: true,
		success: function (result) {
			if (result.code === '0000') {
				if (result.data.length === 0) {
					return false;
				}
				ulObj.show();
				var ul = '';
				jQuery.each(result.data, function (k, v) {
					var li = '<li><i>' + (k + 1) + '</i>';
					li += '<a href="' + v.threadUrl + '" ><span>' + v.subject + '</span></a>';
					li += '</li>';
					ul += li;
				});
				ulObj.find('.recommend-list').append(ul);
				ulObj.find('.recommend-list a').click(function () {
					dmpda_click('click_thread','recommended_thread');
				});
			}
		}
	});
}
